<view class="page-wrapper {{isPageActive ? 'page-active' : ''}}">
  <view class="top-bar">
    <view class="title-lg">职业地图</view>
    <picker mode="selector" range="{{careerOptions}}" range-key="name" value="{{selectedIndex}}" bindchange="onCareerChange">
      <view class="career-picker">
        <text class="picker-text">{{careerOptions[selectedIndex].name}}</text>
        <text class="picker-icon">▼</text>
      </view>
    </picker>
  </view>

  <scroll-view scroll-y class="page-content">
    <view class="container">
      
      <!-- Loading 状态 -->
      <view wx:if="{{loading}}" class="loading-wrapper">
        <view class="loading-text">加载中...</view>
      </view>

      <!-- 职业信息卡片 -->
      <view wx:if="{{!loading && currentCareer}}" class="card flex-between">
        <view class="flex-row">
          <view class="job-icon-box">{{currentCareer.icon}}</view>
          <view class="ml-3">
            <view class="title-md">{{currentCareer.name}}</view>
            <view class="sub-text mt-2">{{currentCareer.currentLevel}} | 经验 {{currentCareer.experience}}</view>
          </view>
        </view>
        <!-- 编辑功能暂时隐藏，待后续版本完善 -->
        <!-- <view class="icon-btn-light" bindtap="editCareer">✏️</view> -->
      </view>

      <!-- 能力图谱 -->
      <view wx:if="{{!loading && currentCareer}}" class="map-card-container">
        <view class="map-header">
          <text class="map-title">能力图谱</text>
          <view class="map-legend">
            <view class="dot active"></view><text>已点亮</text>
          </view>
        </view>

        <view class="mindmap-wrapper">
          
          <!-- 中心核心 -->
          <view class="core-center">
            <view class="core-inner">{{currentCareer.icon}}</view>
            <view class="core-halo"></view>
          </view>

          <!-- 动态渲染分支节点 -->
          <block wx:for="{{currentCareer.branches}}" wx:key="name">
            <view class="branch-ray" 
                  style="transform: rotate({{item.angle}}deg); --branch-length: {{item.distance}}rpx; opacity: {{item.unlocked ? 1 : 0.6}};"
                  bindtap="onNodeTap"
                  data-node="{{item}}">
              <view class="branch-line {{item.unlocked ? '' : 'dashed'}}" style="--branch-length: {{item.distance}}rpx;"></view>
              <view class="node-item" style="--node-offset: {{item.distance + 60}}rpx;">
                <view class="node-circle {{item.unlocked ? '' : 'small'}}">{{item.emoji}}</view>
                <text wx:if="{{item.unlocked}}" class="node-text">{{item.name}}</text>
              </view>
            </view>
          </block>

        </view>
      </view>

      <!-- 下一阶段目标 -->
      <view wx:if="{{!loading && currentCareer && currentCareer.nextGoal}}" class="section-header mb-3 mt-4">
        <text class="title-md">下一阶段目标</text>
      </view>
      <view wx:if="{{!loading && currentCareer && currentCareer.nextGoal}}" class="card">
        <view class="flex-between">
          <view class="flex-row">
            <view class="step-circle">{{currentCareer.nextGoal.step}}</view>
            <view class="ml-3">
              <view class="text-bold">{{currentCareer.nextGoal.title}}</view>
              <view class="sub-text">{{currentCareer.nextGoal.subtitle}}</view>
            </view>
          </view>
          <text class="text-xs text-primary">{{currentCareer.nextGoal.status}}</text>
        </view>
      </view>

    </view>
  </scroll-view>

  <!-- 节点详情弹窗 -->
  <view wx:if="{{showNodeDetail}}" class="modal-mask" bindtap="closeNodeDetail">
    <view class="modal-content" catchtap="">
      <view class="modal-header">
        <text class="modal-title">{{selectedNode.name}}</text>
        <view class="close-btn" bindtap="closeNodeDetail">✕</view>
      </view>
      <view class="modal-body">
        <view class="modal-icon">{{selectedNode.emoji}}</view>
        <view class="modal-desc">{{selectedNode.description}}</view>
      </view>
      <view class="modal-footer">
        <button class="btn-primary" bindtap="closeNodeDetail">知道了</button>
      </view>
    </view>
  </view>
</view>